<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Volleyball Match Manager - Auto GitHub Sync</title>
    <style>
        /* (kept exactly your styles) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .content { padding: 40px; }
        .github-setup { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .github-setup h3 { color: #92400e; margin-bottom: 15px; }
        .github-setup.configured { background: #d1fae5; border-left-color: #10b981; }
        .github-setup.configured h3 { color: #065f46; }
        .setup-form { display: grid; gap: 15px; margin-top: 15px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #334155; font-weight: 600; font-size: 14px; }
        .form-group input[type="text"], .form-group input[type="password"], .form-group input[type="date"], .form-group select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3b82f6; }
        .section-title { font-size: 24px; color: #1e3a8a; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #3b82f6; }
        .match-form { background: #f8fafc; padding: 30px; border-radius: 15px; border: 2px solid #e2e8f0; margin-bottom: 30px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .team-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .team-section h3 { color: #1e3a8a; margin-bottom: 15px; }
        .button-group { display: flex; gap: 15px; margin-top: 30px; }
        .btn { flex: 1; padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; position: relative; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .status-message { padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        .status-message.success { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
        .status-message.error { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }
        .status-message.info { background: #dbeafe; color: #1e40af; border: 2px solid #3b82f6; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .help-text { font-size: 13px; color: #64748b; margin-top: 5px; }
        .match-history { margin-top: 40px; }
        .match-item { background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #e2e8f0; }
        .match-item h4 { color: #1e3a8a; margin-bottom: 10px; }
        .match-meta { color: #64748b; font-size: 14px; margin-bottom: 10px; }
        .sync-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-top: 5px; }
        .sync-badge.synced { background: #d1fae5; color: #065f46; }
        .sync-badge.pending { background: #fef3c7; color: #92400e; }
        code { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏐 Auto-Sync Match Manager</h1>
            <p>Δημιουργήστε αγώνες και ανεβάστε τα αυτόματα στο GitHub!</p>
        </div>

        <div class="content">
            <div class="github-setup" id="githubSetup">
                <h3>⚙️ GitHub Configuration</h3>
                <p>Για αυτόματη αποθήκευση στο GitHub, χρειάζεστε ένα Personal Access Token.</p>
                <div class="setup-form">
                    <div class="form-group">
                        <label>GitHub Username *</label>
                        <input type="text" id="githubUsername" placeholder="volleyleaguecupgr">
                        <div class="help-text">Το username σας στο GitHub</div>
                    </div>
                    <div class="form-group">
                        <label>Repository Name *</label>
                        <input type="text" id="githubRepo" placeholder="intro">
                        <div class="help-text">Το όνομα του repository</div>
                    </div>
                    <div class="form-group">
                        <label>Personal Access Token *</label>
                        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                        <div class="help-text">
                            <a href="https://github.com/settings/tokens/new?scopes=repo&description=Volleyball%20Match%20Manager" target="_blank" style="color: #3b82f6;">
                                Δημιουργήστε token εδώ
                            </a> (χρειάζεται repo access)
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="saveGitHubBtn">💾 Αποθήκευση Ρυθμίσεων</button>
                </div>
            </div>

            <div class="status-message" id="statusMessage"></div>

            <div class="section-title">Δημιουργία Νέου Αγώνα</div>

            <form id="matchForm">
                <div class="match-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ημερομηνία Αγώνα *</label>
                            <input type="date" id="matchDate" required>
                        </div>
                        <div class="form-group">
                            <label>Αγωνιστική *</label>
                            <input type="text" id="league" value="η ΑΓΩΝΙΣΤΙΚΗ" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="team-section">
                            <h3>🏠 Γηπεδούχος</h3>
                            <div class="form-group">
                                <label>Ομάδα *</label>
                                <select id="homeTeam" required><option value="">Επιλέξτε ομάδα...</option></select>
                            </div>
                            <div class="form-group">
                                <label>Υπότιτλος</label>
                                <input type="text" id="homeSubtitle" placeholder="LEAVE EMPTY">
                            </div>
                        </div>

                        <div class="team-section">
                            <h3>✈️ Φιλοξενούμενος</h3>
                            <div class="form-group">
                                <label>Ομάδα *</label>
                                <select id="awayTeam" required><option value="">Επιλέξτε ομάδα...</option></select>
                            </div>
                            <div class="form-group">
                                <label>Υπότιτλος</label>
                                <input type="text" id="awaySubtitle" placeholder="LEAVE EMPTY">
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary" id="saveBtn">🚀 Αποθήκευση & Auto-Upload</button>
                        <button type="button" class="btn btn-secondary" id="previewBtn">👁️ Προεπισκόπηση</button>
                        <button type="button" class="btn btn-warning" id="manualDownloadBtn">📥 Μη-αυτόματη Λήψη</button>
                    </div>
                </div>
            </form>

            <div class="match-history">
                <h2 class="section-title">Ιστορικό Αγώνων</h2>
                <div id="matchHistory"></div>
            </div>
        </div>
    </div>

    <!-- SCRIPT: at end of body to ensure DOM exists and no early execution issues -->
    <script>
    console.log("✅ Script loaded");

    // data containers
    const teams = {};
    const matches = {};
    let githubConfig = null;

    // default teams - use double quotes for safety (apostrophes inside values won't break)
    const defaultTeams = [
        { name: "Παναθηναϊκός", slug: "panathinaikos", color: "#16a34a", logo: "panathinaikos.png", subtitle: "Α.Ο." },
        { name: "Ολυμπιακός", slug: "olympiakos", color: "#dc1414", logo: "olympiakos.png", subtitle: "Σ.Φ.Π ΟΝΕΧ" },
        { name: "Π.Α.Ο.Κ.", slug: "paok", color: "#000000", logo: "paok.png", subtitle: "Α.Σ." },
        { name: "Καλαμάτα", slug: "kalamata", color: "#008428", logo: "kalamata.png", subtitle: "A.O. '80" },
        { name: "Φλοίσβος", slug: "floisvos", color: "#3a55a8", logo: "floisvos.png", subtitle: "A. O." },
        { name: "Φοίνικας Σύρου", slug: "foinikas", color: "#2e3192", logo: "foinikas.png", subtitle: "A.O." },
        { name: "Κηφισιά", slug: "kifisia", color: "#283980", logo: "kifisia.png", subtitle: "A.Ο.Π.Σ." },
        { name: "Μίλων", slug: "milon", color: "#00772b", logo: "milon.png", subtitle: "Α.Ο.Ν.Σ" },
        { name: "Ο.Φ.Η.", slug: "ofi", color: "#000000", logo: "ofi.png", subtitle: "." },
        { name: "Πανιώνιος", slug: "panionios", color: "#db1921", logo: "panionios.png", subtitle: "Γ.Σ.Σ." }
    ];

    // helper: safe get element
    function $id(id) { return document.getElementById(id); }

    document.addEventListener("DOMContentLoaded", () => {
        console.log("✅ DOM ready, initializing...");

        loadFromLocalStorage();

        if (Object.keys(teams).length === 0) {
            defaultTeams.forEach(t => teams[t.slug] = t);
            saveToLocalStorage();
        }

        populateTeamSelects();
        displayMatchHistory();

        // set today's date
        const today = new Date().toISOString().split("T")[0];
        $id("matchDate").value = today;

        // bind buttons
        $id("saveGitHubBtn").addEventListener("click", saveGitHubConfig);
        $id("previewBtn").addEventListener("click", handlePreview);
        $id("manualDownloadBtn").addEventListener("click", handleManualDownload);

        console.log("✅ Event listeners added");
    });

    function populateTeamSelects(){
        const home = $id("homeTeam");
        const away = $id("awayTeam");
        home.innerHTML = '<option value="">Επιλέξτε ομάδα...</option>';
        away.innerHTML = '<option value="">Επιλέξτε ομάδα...</option>';
        Object.values(teams).forEach(team => {
            const o1 = new Option(team.name, team.slug);
            const o2 = new Option(team.name, team.slug);
            home.add(o1);
            away.add(o2);
        });
        console.log("✅ Team selects populated:", Object.keys(teams).length);
    }

    function saveGitHubConfig(){
        const username = $id("githubUsername").value.trim();
        const repo = $id("githubRepo").value.trim();
        const token = $id("githubToken").value.trim();
        if (!username || !repo || !token) { showStatus("error","Συμπληρώστε όλα τα πεδία!"); return; }
        githubConfig = { username, repo, token };
        localStorage.setItem("githubConfig", JSON.stringify(githubConfig));
        updateGitHubStatus(true);
        showStatus("success","✅ Οι ρυθμίσεις GitHub αποθηκεύτηκαν!");
    }

    function updateGitHubStatus(isConfigured){
        const box = $id("githubSetup");
        if (isConfigured && githubConfig) {
            box.classList.add("configured");
            box.querySelector("h3").textContent = "✅ GitHub Configured";
            box.querySelector("p").textContent = `Συνδεδεμένο με: ${githubConfig.username}/${githubConfig.repo}`;
        }
    }

    // MAIN FORM
    document.addEventListener("submit", async (e) => {
        if (e.target && e.target.id === "matchForm") {
            e.preventDefault();
            const homeSlug = $id("homeTeam").value;
            const awaySlug = $id("awayTeam").value;
            const saveBtn = $id("saveBtn");

            if (homeSlug === awaySlug) { showStatus("error","Οι ομάδες πρέπει να είναι διαφορετικές!"); return; }
            if (!githubConfig) { showStatus("error","Παρακαλώ ρυθμίστε το GitHub πρώτα!"); return; }

            const matchData = createMatchData(homeSlug, awaySlug);
            matches[matchData.id] = matchData;
            teams[homeSlug].latestMatch = matchData.id;
            teams[awaySlug].latestMatch = matchData.id;
            saveToLocalStorage();

            saveBtn.disabled = true;
            saveBtn.innerHTML = '⏳ Ανέβασμα στο GitHub...<span class="spinner"></span>';
            const statusMessage = $id("statusMessage");
            statusMessage.style.display = "block";
            statusMessage.className = "status-message info";
            statusMessage.textContent = "⏳ Γίνεται αποστολή στο GitHub... Μην κάνετε άλλη υποβολή.";

            try {
                await uploadMatchToGitHub(homeSlug, awaySlug, matchData);
                matchData.synced = true;
                saveToLocalStorage();
                displayMatchHistory();

                let cd = 5;
                statusMessage.className = "status-message success";
                statusMessage.textContent = `✅ Επιτυχής αποστολή! Νέα υποβολή σε ${cd}s...`;
                const timer = setInterval(()=> {
                    cd--;
                    if (cd <= 0) {
                        clearInterval(timer);
                        statusMessage.style.display = "none";
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = "🚀 Αποθήκευση & Auto-Upload";
                    } else {
                        statusMessage.textContent = `✅ Επιτυχής αποστολή! Νέα υποβολή σε ${cd}s...`;
                    }
                }, 1000);
            } catch(err){
                console.error("Upload error:", err);
                matchData.synced = false;
                saveToLocalStorage();
                showStatus("error", `❌ Σφάλμα: ${err.message || err}`);
                saveBtn.disabled = false;
                saveBtn.innerHTML = "🚀 Αποθήκευση & Auto-Upload";
            }

            // reset form
            e.target.reset();
            $id("matchDate").value = new Date().toISOString().split("T")[0];
        }
    });

    function createMatchData(homeSlug, awaySlug){
        return {
            id: Date.now().toString(),
            date: $id("matchDate").value,
            league: $id("league").value,
            homeTeam: { ...teams[homeSlug], subtitle: $id("homeSubtitle").value || teams[homeSlug].subtitle },
            awayTeam: { ...teams[awaySlug], subtitle: $id("awaySubtitle").value || teams[awaySlug].subtitle },
            createdAt: new Date().toISOString(),
            synced: false
        };
    }

    // GitHub single-commit upload (same approach you had)
    async function uploadMatchToGitHub(homeSlug, awaySlug, matchData){
        if (!githubConfig) throw new Error("No GitHub config");
        const { username, repo, token } = githubConfig;
        const branch = "main";
        const jsonData = { homeTeam: matchData.homeTeam, awayTeam: matchData.awayTeam, date: formatGreekDate(new Date(matchData.date)), league: matchData.league };
        const homePath = `teams/${homeSlug}.json`;
        const awayPath = `teams/${awaySlug}.json`;

        // Step 1: get branch ref
        const branchInfo = await ghGet(`repos/${username}/${repo}/git/ref/heads/${branch}`, token);
        const latestCommitSha = branchInfo.object.sha;
        const commitInfo = await ghGet(`repos/${username}/${repo}/git/commits/${latestCommitSha}`, token);
        const baseTreeSha = commitInfo.tree.sha;

        const homeBlob = await ghPost(`repos/${username}/${repo}/git/blobs`, token, { content: JSON.stringify(jsonData, null, 2), encoding: "utf-8" });
        const awayBlob = await ghPost(`repos/${username}/${repo}/git/blobs`, token, { content: JSON.stringify(jsonData, null, 2), encoding: "utf-8" });

        const newTree = await ghPost(`repos/${username}/${repo}/git/trees`, token, {
            base_tree: baseTreeSha,
            tree: [
                { path: homePath, mode: "100644", type: "blob", sha: homeBlob.sha },
                { path: awayPath, mode: "100644", type: "blob", sha: awayBlob.sha }
            ]
        });

        const newCommit = await ghPost(`repos/${username}/${repo}/git/commits`, token, {
            message: `Update match data for ${homeSlug} vs ${awaySlug}`,
            tree: newTree.sha,
            parents: [latestCommitSha]
        });

        await ghPatch(`repos/${username}/${repo}/git/refs/heads/${branch}`, token, { sha: newCommit.sha });
        console.log("GitHub upload complete");
    }

    async function ghGet(endpoint, token){
        const res = await fetch(`https://api.github.com/${endpoint}`, { headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" } });
        if (!res.ok) {
            let data = {};
            try { data = await res.json(); } catch(e){}
            throw new Error(`${res.status} ${res.statusText} - ${data.message || ""}`);
        }
        return res.json();
    }
    async function ghPost(endpoint, token, body){
        const res = await fetch(`https://api.github.com/${endpoint}`, {
            method: "POST",
            headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json", "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            let data = {};
            try { data = await res.json(); } catch(e){}
            throw new Error(`${res.status} ${res.statusText} - ${data.message || ""}`);
        }
        return res.json();
    }
    async function ghPatch(endpoint, token, body){
        const res = await fetch(`https://api.github.com/${endpoint}`, {
            method: "PATCH",
            headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json", "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            let data = {};
            try { data = await res.json(); } catch(e){}
            throw new Error(`${res.status} ${res.statusText} - ${data.message || ""}`);
        }
        return res.json();
    }

    function handlePreview(){
        const home = $id("homeTeam").value;
        const away = $id("awayTeam").value;
        if (!home || !away) return showStatus("error","Επιλέξτε και τις δύο ομάδες!");
        const data = createMatchData(home, away);
        const params = new URLSearchParams({
            homeName: data.homeTeam.name, homeSubtitle: data.homeTeam.subtitle, awayName: data.awayTeam.name,
            awaySubtitle: data.awayTeam.subtitle, date: formatGreekDate(new Date(data.date)), league: data.league
        });
        window.open("intro.html?" + params.toString(), "_blank");
    }

    function handleManualDownload(){
        const home = $id("homeTeam").value;
        const away = $id("awayTeam").value;
        if (!home || !away) return showStatus("error","Επιλέξτε και τις δύο ομάδες!");
        const data = createMatchData(home, away);
        const jsonData = { homeTeam: data.homeTeam, awayTeam: data.awayTeam, date: formatGreekDate(new Date(data.date)), league: data.league };
        downloadFile(`${home}.json`, JSON.stringify(jsonData, null, 2), "application/json");
        downloadFile(`${away}.json`, JSON.stringify(jsonData, null, 2), "application/json");
        showStatus("success", "✅ Αρχεία κατέβηκαν!");
    }

    function downloadFile(filename, content, mime){
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = filename; document.body.appendChild(a);
        a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function showStatus(type, message){
        const el = $id("statusMessage");
        el.className = `status-message ${type}`;
        el.textContent = message;
        el.style.display = "block";
        setTimeout(()=>{ el.style.display = "none"; }, 8000);
    }

    function displayMatchHistory(){
        const container = $id("matchHistory");
        container.innerHTML = "";
        const arr = Object.values(matches).sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
        if (arr.length === 0) { container.innerHTML = '<p style="text-align:center;color:#64748b;">Δεν υπάρχουν αγώνες</p>'; return; }
        arr.forEach(m => {
            const div = document.createElement("div");
            div.className = "match-item";
            div.innerHTML = `<h4>${m.homeTeam.name} vs ${m.awayTeam.name}</h4>
                <div class="match-meta">📅 ${new Date(m.date).toLocaleDateString('el-GR')} | 🏆 ${m.league}</div>
                <span class="sync-badge ${m.synced ? 'synced' : 'pending'}">${m.synced ? '✓ Synced to GitHub' : '⏳ Local only'}</span>`;
            container.appendChild(div);
        });
    }

    function formatGreekDate(date){
        const months = ["Ιανουαρίου","Φεβρουαρίου","Μαρτίου","Απριλίου","Μαΐου","Ιουνίου","Ιουλίου","Αυγούστου","Σεπτεμβρίου","Οκτωβρίου","Νοεμβρίου","Δεκεμβρίου"];
        return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    function saveToLocalStorage(){
        localStorage.setItem("volleyballTeams", JSON.stringify(teams));
        localStorage.setItem("volleyballMatches", JSON.stringify(matches));
    }
    function loadFromLocalStorage(){
        const t = localStorage.getItem("volleyballTeams");
        const m = localStorage.getItem("volleyballMatches");
        const g = localStorage.getItem("githubConfig");
        if (t) Object.assign(teams, JSON.parse(t));
        if (m) Object.assign(matches, JSON.parse(m));
        if (g) {
            githubConfig = JSON.parse(g);
            $id("githubUsername").value = githubConfig.username;
            $id("githubRepo").value = githubConfig.repo;
            $id("githubToken").value = githubConfig.token;
            updateGitHubStatus(true);
        }
    }
    </script>
</body>
</html>
